name: Build and Deploy to OpenShift

on:
  push:
    branches: [ main ]

env:
  BACKEND_IMAGE: ghcr.io/csingfe/guestbook-backend
  FRONTEND_IMAGE: ghcr.io/csingfe/guestbook-frontend

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build backend
        run: docker build -t ${{ env.BACKEND_IMAGE }}:latest -f Dockerfile.backend .

      - name: Build frontend
        run: docker build -t ${{ env.FRONTEND_IMAGE }}:latest -f Dockerfile.frontend .

      - name: Push backend
        run: docker push ${{ env.BACKEND_IMAGE }}:latest

      - name: Push frontend
        run: docker push ${{ env.FRONTEND_IMAGE }}:latest

      - name: Install oc
        uses: redhat-actions/oc-installer@v1
        with:
          oc_version: '4.14'

      - name: Login to OpenShift
        uses: redhat-actions/oc-login@v1
        with:
          openshift_server_url: ${{ secrets.OPENSHIFT_SERVER }}
          openshift_token: ${{ secrets.OPENSHIFT_TOKEN }}
          namespace: ${{ secrets.OPENSHIFT_NAMESPACE }}
          insecure_skip_tls_verify: true

      - name: Create pull secret
        run: |
          oc create secret docker-registry ghcr-secret \
            --docker-server=ghcr.io \
            --docker-username=${{ github.actor }} \
            --docker-password=${{ secrets.GITHUB_TOKEN }} \
            --dry-run=client -o yaml | oc apply -f -

      - name: Deploy
        run: |
          oc apply -f config.yaml
          oc apply -f backend.yaml
          oc apply -f frontend.yaml

      - name: Wait
        run: |
          oc rollout status deployment/backend --timeout=5m
          oc rollout status deployment/nginx --timeout=5m

